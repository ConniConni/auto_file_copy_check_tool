# Python製業務効率化CLIツール - 仕様書

## 1. アプリケーション概要

プロジェクトにおいて、**内部作業用エリア**と**外部提出用エリア**（お客様との共有）の間で、ドキュメントやレビュー記録表の受け渡し（コピー）を支援するCLIツール。

### 目的と解決する課題
- **双方向コピー**: 「内部→外部（提出）」と「外部→内部（取込）」の両方に対応
- **ミス防止**: 手動操作によるコピー忘れ、誤った上書き、古いファイルの混入を防ぐ
- **品質担保**: ドキュメントの内容不備を検出し、警告としてユーザーに知らせる（コピー自体は阻害しない）
- **環境対応**: Windows/macOS両対応。パスエラーやファイルロック時のクラッシュを防ぐ堅牢な設計

---

## 2. ディレクトリ構造

### 2.1 内部エリア（プロジェクトメンバー作業用）

**ベースパス**: `config.ini` の `base_path_internal`

**パス構築**: `[base_path_internal]/[案件名]/[yyyy_xQ]/[アイテム名]/[工程名]/...`

```
[工程名]/ (例: 030.調査)
├── ドキュメント本体.xlsx  ← 配置場所A（コピー元/先）
└── 成果物/
    ├── 内部レビュー/
    │   ├── 20251215/  ← 日付フォルダ（ある場合とない場合がある）
    │   │   ├── レビュー記録表_調査_社内_1回目_xxx.xlsx
    │   │   ├── レビュー記録表_調査_社外_1回目_xxx.xlsx
    │   │   └── レビューチェックリスト_030_社内_1回目_xxx.xlsx
    │   └── (または直下にファイルがある場合もある)
    │
    └── 外部レビュー/
        ├── 20251219/  ← 日付フォルダ（ある場合とない場合がある）
        │   ├── レビュー記録表(社外)_1回目_調査_xxx.xlsx  ← コピー対象
        │   └── レビューチェックリスト_030_社外_1回目_xxx.xlsx
        └── (または直下にファイルがある場合もある)
```

### 2.2 外部エリア（お客様との共有用）

**ベースパス**: `config.ini` の `base_path_external`

**パス構築**: `[base_path_external]/[案件名]/[yyyy_xQ]/[アイテム名]/[工程名]/...`

**特徴**: 内部エリアよりシンプルな構造。日付フォルダなし。

```
[工程名]/ (例: 030.調査)
├── ドキュメント本体.xlsx  ← コピー先/元
└── 成果物/
    └── レビュー記録表(社外)_1回目_調査_xxx.xlsx  ← コピー先/元
```

### 2.3 工程定義

以下の工程をサポート（ディレクトリ名は完全一致）:
- `030.調査`
- `040.設計`
- `050.製造`
- `060.UD作成`
- `070.UD消化`
- `080.SD作成`
- `090.SD消化`

---

## 3. 機能要件

### 3.1 動作モード

#### ① Outgoing（内部→外部：提出）

**対象工程**: `030`, `040`, `080`, `090`

**コピールール**:

1. **ドキュメント本体**
   - 元: `[internal]/[工程名]/[ドキュメント名パターン]_*.xlsx`
   - 先: `[external]/[工程名]/[ドキュメント名パターン]_*.xlsx`
   - 例: `調査検討書_*.xlsx`, `機能設計書_*.xlsx` など

2. **レビュー記録表（社外）**
   - 元: `[internal]/[工程名]/成果物/外部レビュー/**/レビュー記録表(社外)_*.xlsx`
   - 先: `[external]/[工程名]/成果物/レビュー記録表(社外)_*.xlsx`
   - ※ 日付フォルダがある場合は再帰的に検索

3. **例外ファイル**
   - 元: `[internal]/[工程名]/成果物/外部レビュー/` 内で、config.iniで指定したファイル名（完全一致）
   - 先: `[external]/[工程名]/成果物/`

#### ② Incoming（外部→内部：取込）

**対象工程**: 全工程

**コピールール**:

1. **ドキュメント本体**
   - 元: `[external]/[工程名]/[ドキュメントファイル].xlsx`
   - 先: `[internal]/[工程名]/` 直下へ上書きコピー
   - ※ 内部にファイルが存在しない場合は新規コピー

2. **レビュー記録表**
   - 元: `[external]/[工程名]/成果物/レビュー記録表_*.xlsx`
   - 先: `[internal]/[工程名]/` 配下を再帰的に検索し、ファイル名が完全一致するファイルへ上書きコピー
   - **警告**: 内部に同名ファイルが見つからない場合、「コピー先不明」として警告を出し、コピーはスキップ

### 3.2 共通ロジック（期間フィルタ）

**仕様**: ユーザー入力値 `N`（日数）に基づき、「N日前の0:00以降」に更新されたファイルのみを対象とする。

- `0`: 今日（Today 0:00 ~ Now）
- `1`: 昨日以降（Yesterday 0:00 ~ Now）
- `7`: 7日前以降（7 days ago 0:00 ~ Now）

### 3.3 ドキュメント内容チェック（品質確認）

**位置付け**: コピー可否には影響しない「警告」機能。Outgoingモード時に特に有効。

**対象**:
- コピー候補ファイル
- `成果物/内部レビュー` 内または `成果物/外部レビュー` 内のレビューチェックリスト

**チェック項目**:

1. **レビュー記録表**:
   - `AE2` (レビュー名称): 必須
   - `AE8` (内部メンバ): 必須
   - `AE7` (外部メンバ): ファイル名に `(社外)` を含む場合のみ必須

2. **レビューチェックリスト**:
   - `E4-E6` (案件情報): 必須
   - `N6` (日付): 必須
   - `M15` (外部メンバ): ファイル名に `社外` を含む場合のみ必須

---

## 4. 技術要件

### 4.1 使用技術
- **言語**: Python 3.10+
- **開発手法**: TDD (Test-Driven Development)
- **主要ライブラリ**:
  - `pathlib`: クロスプラットフォーム対応のパス操作
  - `openpyxl`: Excelファイルの内容チェック
  - `configparser`: 設定ファイル読み込み
  - `datetime`: 期間フィルタ処理
  - `pytest`: テストフレームワーク

### 4.2 設定ファイル（config.ini）

```ini
[Paths]
base_path_internal = /path/to/internal/area
base_path_external = /path/to/external/area

[Documents]
# 各工程のドキュメント本体ファイル名パターン（プレフィックス）
030 = 調査検討書
040 = 機能設計書
050 =
060 = 単体試験仕様書
070 = 単体試験成績書
080 = 結合試験仕様書
090 = 結合試験成績書,試験結果報告書

[ExtraFiles]
# 例外ファイル（完全一致のファイル名、カンマ区切り）
# 例: 補足資料.pdf,説明書.docx
include_files =
```

### 4.3 堅牢性要件

1. **ファイルロック対応**:
   - Excelファイルが開かれている場合（`PermissionError`）、ツールをクラッシュさせない
   - エラーログを出力して次のファイルへ進む

2. **パス操作**:
   - `pathlib` を使用し、Windows/macOSの両方のパス区切りに対応

3. **エラーハンドリング**:
   - パスが存在しない場合は明確なエラーメッセージ
   - コピー失敗時も処理を継続

### 4.4 コーディング規約

**重要**: 実装にあたっては、`codingroles.md` に記載されたコーディング規約を必ず遵守してください。

主要な規約:
- PEP 8準拠
- Type Hinting必須（Python 3.10+記法）
- Docstring必須（Google Style）
- `pathlib`必須（`os.path.join`禁止）
- Enumで定数管理
- dataclassでconfig管理
- loggingモジュール使用（`print()`禁止）

詳細は [`codingroles.md`](./codingroles.md) を参照してください。

---

## 5. CLI インタラクションフロー

### 5.1 初期設定
1. `config.ini` をロード
2. ユーザー入力を取得:
   - 案件名
   - クォータ（例: 2025_4Q）
   - アイテム名
   - 工程選択（リスト選択 or 全工程一括）
   - モード選択（1: Outgoing / 2: Incoming）
   - 期間フィルタ（N日前以降、0=今日のみ）

### 5.2 スキャン & Dry Run表示
1. 構成されたパスが存在するか確認（なければエラー終了）
2. 対象となるファイル一覧を表示
3. **Outgoingモード時**:
   - Excelの内容チェック結果（OK/NG）を併記
4. **Incomingモード時**:
   - 「上書き対象が見つかりません」等の警告があれば表示

### 5.3 実行確認
- ユーザーが `y` を入力した場合のみコピーを実行
- `n` の場合は終了

### 5.4 完了
- ログファイルに結果を出力
- 成功/失敗/警告の件数を表示

---

## 6. 成果物

- `src/main.py`: スクリプト本体
- `src/config_loader.py`: 設定ファイル読み込みモジュール
- `src/file_scanner.py`: ファイルスキャンモジュール
- `src/file_copier.py`: ファイルコピーモジュール
- `src/excel_checker.py`: Excel内容チェックモジュール
- `tests/test_*.py`: 各モジュールのテストコード
- `config.ini`: 設定ファイルテンプレート
- `requirements.txt`: 依存ライブラリ
- `README.md`: 使用方法の説明

---

## 7. 補足仕様

### 7.1 ファイル名パターン
- **レビュー記録表（社外）**: `レビュー記録表(社外)_*.xlsx` で固定
- **ドキュメント本体**: config.iniで各工程ごとに定義
- **例外ファイル**: config.iniで完全一致のファイル名を指定

### 7.2 工程処理
- 基本: 全工程を一括処理
- オプション: 特定の工程のみ選択可能（実装が簡単な場合）

### 7.3 複数ファイル対応
- 工程直下に複数のExcelファイルがある場合:
  - config.iniで指定したパターンに一致するもののみコピー対象
  - パターンに一致しないファイルは無視

### 7.4 日付フォルダ対応
- `成果物/外部レビュー/` 配下を再帰的に検索
- 日付フォルダ（`20251215/` など）がある場合もない場合も対応
- 最新更新日時のファイルを優先（期間フィルタ適用）

---

## 8. エラーケースと対処

| エラーケース | 対処方法 |
|------------|---------|
| 設定ファイルが存在しない | エラーメッセージを表示して終了 |
| パスが存在しない | エラーメッセージを表示して終了 |
| ファイルが開かれている | 警告ログを出力して次のファイルへ |
| コピー先が見つからない（Incoming） | 警告ログを出力してスキップ |
| Excel読み込み失敗 | 警告ログを出力（コピーは実行） |
| 権限エラー | エラーログを出力して次のファイルへ |

---

## 9. ログ出力仕様

### 9.1 ログレベル
- **INFO**: 正常なコピー処理
- **WARNING**: Excel内容チェックNG、コピー先不明など
- **ERROR**: ファイルアクセスエラー、権限エラーなど

### 9.2 ログファイル
- ファイル名: `file_copy_tool_YYYYMMDD_HHMMSS.log`
- 保存先: ツール実行ディレクトリ
- フォーマット: `[YYYY-MM-DD HH:MM:SS] [LEVEL] メッセージ`

---

## 10. TDD実装手順

### Phase 1: 設定ファイル処理
1. **テスト作成**: `tests/test_config_loader.py`
   - config.iniの読み込みテスト
   - パス存在チェックのテスト
   - 工程別ドキュメントパターンの取得テスト
2. **実装**: `src/config_loader.py`

### Phase 2: ファイルスキャン機能
1. **テスト作成**: `tests/test_file_scanner.py`
   - ドキュメント本体のスキャンテスト
   - レビュー記録表のスキャンテスト（再帰検索）
   - 期間フィルタのテスト
   - 例外ファイルのスキャンテスト
2. **実装**: `src/file_scanner.py`

### Phase 3: Excel内容チェック機能
1. **テスト作成**: `tests/test_excel_checker.py`
   - レビュー記録表のチェックテスト
   - レビューチェックリストのチェックテスト
   - ファイルロック時のエラーハンドリングテスト
2. **実装**: `src/excel_checker.py`

### Phase 4: ファイルコピー機能
1. **テスト作成**: `tests/test_file_copier.py`
   - Outgoingモードのコピーテスト
   - Incomingモードのコピーテスト
   - 上書き/新規作成のテスト
   - エラーハンドリングテスト
2. **実装**: `src/file_copier.py`

### Phase 5: CLIインタラクション
1. **テスト作成**: `tests/test_main.py`
   - ユーザー入力のテスト（モック使用）
   - Dry Run表示のテスト
   - 統合テスト
2. **実装**: `src/main.py`

### Phase 6: 統合テストとドキュメント
1. エンドツーエンドテストの実施
2. README.mdの作成
3. requirements.txtの最終確認

---

## 11. テスト戦略

### 11.1 ユニットテスト
- 各モジュールの関数レベルでのテスト
- エッジケース（空ファイル、存在しないパスなど）のテスト
- エラーハンドリングのテスト

### 11.2 統合テスト
- モジュール間の連携テスト
- 実際のディレクトリ構造を模したテストフィクスチャの使用

### 11.3 テストカバレッジ目標
- 最低80%以上のコードカバレッジ
- 重要なビジネスロジックは100%カバー

---

## 12. プロジェクト構造

```
auto_file_copy_check_tool/
├── src/
│   ├── __init__.py
│   ├── main.py
│   ├── config_loader.py
│   ├── file_scanner.py
│   ├── file_copier.py
│   └── excel_checker.py
├── tests/
│   ├── __init__.py
│   ├── test_config_loader.py
│   ├── test_file_scanner.py
│   ├── test_file_copier.py
│   ├── test_excel_checker.py
│   └── test_main.py
├── config.ini
├── requirements.txt
├── README.md
├── CLAUDE.md
└── yoken.md
```
